<!DOCTYPE html>
<html>

<head>
	<title>ChatAnywhere</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
	<link rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/monokai-sublime.min.css">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<style>
		body,
		.container {
			background-color: #1E1E1E;
			color: #FFFFFF;
		}

		.message,
		.message-input {
			background-color: #444654;
			color: #FFF;
			border-radius: 5px;
			padding: 10px;
			border: none;
			margin-bottom: 10px;
			white-space: pre-wrap;
		}

		.message-input:focus {
			outline: none;
		}

		.bi {
			font-size: 25px;
		}

		pre {
			background-color: #343541;
			color: #FFF;
			padding: 0;
			border: none;
			white-space: pre-wrap;
			word-break: keep-all;
			margin: 0;
			display: block;
		}
	</style>
</head>

<body>
	<script>
		const messages = [];
		const url = "https://chatanywhere-js.onrender.com/api/ChatAnywhereStream";

		const escapeHtml = (unsafe) => {
			return unsafe
				.replace(/&/g, "&amp;")
				.replace(/</g, "&lt;")
				.replace(/>/g, "&gt;")
				.replace(/"/g, "&quot;")
				.replace(/'/g, "&#039;");
		}
		const getMessagesHtml = (messages) => {
			return messages.map((message, index) => {
				const icon = index % 2 === 0 ? '<i class="bi bi-emoji-sunglasses-fill"></i>' : '<i class="bi bi-robot"></i>';
				message = escapeHtml(message);
				const wrappedMessage = index % 2 !== 0 ? wrapCodeTags(message) : message;
				return `<div class="message"><p>${icon}</p>${wrappedMessage}</div>`;
			}).join('');
		};
		const wrapCodeTags = (str) => {
			const codeBlockRegex = /```(.+)?\n([\s\S]*?)\n```/gm;
			const codeBlockTemplate = '<pre><span> $1</span><code>$2</code></pre>';
			return str.replaceAll(codeBlockRegex, codeBlockTemplate);
		};
		const createMessage = (content, role) => ({ role, content });
		const generateMessages = (messages) => {
			return messages.map((message, index) => {
				const role = index % 2 === 0 ? "user" : "assistant";
				return createMessage(message, role);
			});
		};
		const displayMessages = (messages) => {
			const messageHtml = getMessagesHtml(messages);
			$('#message-container').html(messageHtml);
			hljs.highlightAll();
		};
		const fetchResponse = async (msgs) => {
			let res = await fetch(url, {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify(msgs)
			}).catch((error) => {
				$('#send-button').prop('disabled', true).html('Error, please refresh.').attr("class", "btn btn-warning")
				return;
			});

			let reader = res.body.getReader();
			let result;
			let decoder = new TextDecoder('utf8');
			while (!result?.done) {
				result = await reader.read();
				let chunk = decoder.decode(result.value);
				const arr = chunk.split('\n');
				arr.forEach((data) => {
					if (data.length === 0) return;
					if (data.startsWith(':')) return;
					if (data === 'data: [DONE]') {
						$('#send-button').prop('disabled', false).html("Send");
						return;
					};
					const jsonData = JSON.parse(data.substring(6));
					const delta = jsonData.choices[0].delta;
					if (delta.content != null) {
						messages[messages.length - 1] += delta.content;
					}
					displayMessages(messages);
				});
			}
		}
		const promptGPT = (messages) => {
			$('#message-input').val('');
			$('#send-button').prop('disabled', true).html('Please wait');
			const msgs = generateMessages(messages);
			fetchResponse(msgs);
		};

		$(document).ready(function () {
			displayMessages(messages);
			$('#send-button').click(function (event) {
				event.preventDefault();
				const message = $('#message-input').val();
				messages.push(message);
				messages.push("");
				displayMessages(messages);
				promptGPT(messages);
			});
		});
	</script>
	<div class="container">
		<h1>ChatAnywhere</h1>
		<p>Model: <a href="https://platform.openai.com/docs/guides/chat" target="_blank">gpt-3.5-turbo by OpenAI</a></p>
		<hr>
		<div id="message-container"></div>
		<form>
			<div class="form-group">
				<label for="message-input">Prompt:</label>
				<textarea class="form-control message-input" id="message-input" placeholder="Prompt here"></textarea>
			</div>
			<div style="text-align: right;">
				<button type="submit" class="btn btn-primary" id="send-button">Send</button>
			</div>
			<hr>
		</form>
	</div>
</body>

</html>