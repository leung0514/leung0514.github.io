<!DOCTYPE html>
<html>

<head>
	<title>ChatAnywhere</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
	<link rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/monokai-sublime.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
	<style>
		body,
		.container {
			background-color: #1E1E1E;
			color: #FFFFFF;
		}

		.message,
		.message-input {
			background-color: #444654;
			color: #FFF;
			border-radius: 5px;
			padding: 10px;
			border: none;
			margin-bottom: 10px;
			white-space: pre-wrap;
		}

		.message-input:focus {
			outline: none;
		}

		.bi {
			font-size: 25px;
		}

		pre {
			background-color: #343541;
			color: #FFF;
			padding: 0;
			border: none;
			white-space: pre-wrap;
			word-break: keep-all;
			margin: 0;
			display: block;
		}
	</style>
</head>

<body>
	<script>
		const displayMessages = (messages) => {
			const messageHtml = messages.map((message, index) => {
				const icon = index % 2 === 0 ? '<i class="bi bi-emoji-sunglasses-fill"></i>' : '<i class="bi bi-robot"></i>';
				const content = index % 2 === 0 ? message : wrapCodeTags(message);
				return `<div class="message"><p>${icon}</p>${content}</div>`;
			}).join('');
			$('#message-container').html(messageHtml);
			hljs.highlightAll();
		};

		const handleMessageSend = (messages, inputVal) => {
			const newMessages = [...messages];
			const message = inputVal;
			newMessages.push(message);
			displayMessages(newMessages);
			$('#message-input').val('');

			const xhr = new XMLHttpRequest();
			xhr.open('POST', 'https://chatanywhere.onrender.com/api/ChatAnywhere');
			xhr.setRequestHeader('Content-Type', 'application/json');
			const msgs = newMessages.map((message, index) => ({
				role: index % 2 === 0 ? 'user' : 'assistant',
				content: message,
			}));

			xhr.send(JSON.stringify(msgs));
			$('#send-button').prop('disabled', true).html('Please wait');
			xhr.onreadystatechange = function () {
				if (xhr.readyState === 4 && xhr.status === 200) {
					const response = JSON.parse(xhr.responseText);
					const reply = response.choices[0].message.content;
					const updatedMessages = [...newMessages];
					updatedMessages.push(reply);
					displayMessages(updatedMessages);
					$('#send-button').prop('disabled', false).html('Send');
				} else if (xhr.status === 500 || xhr.status === 502) {
					$('#send-button').prop('disabled', true).html('Error, please refresh.').attr('class', 'btn btn-warning');
					displayMessages(newMessages);
				}
			};
		};

		const wrapCodeTags = (str) => {
			const codeBlockRegex = /```(.+)?\n([\s\S]*?)\n```/gm;
			const codeBlockTemplate = '<pre><span> $1</span><code>$2</code></pre>';
			return str.replace(codeBlockRegex, codeBlockTemplate);
		};

		$(document).ready(function () {
			const messages = [];
			displayMessages(messages);
			$('#send-button').click(function (event) {
				event.preventDefault();
				const inputVal = $('#message-input').val();
				handleMessageSend(messages, inputVal);
			});
		});
	</script>
	<div class="container">
		<h1>ChatAnywhere</h1>
		<p>Model: <a href="https://platform.openai.com/docs/guides/chat" target="_blank">gpt-3.5-turbo by OpenAI</a></p>
		<hr>
		<div id="message-container"></div>
		<form>
			<div class="form-group">
				<label for="message-input">Prompt:</label>
				<textarea class="form-control message-input" id="message-input" placeholder="Prompt here"></textarea>
			</div>
			<div style="text-align: right;">
				<button type="submit" class="btn btn-primary" id="send-button">Send</button>
			</div>
			<hr>
		</form>
	</div>
</body>

</html>